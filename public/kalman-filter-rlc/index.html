<!doctype html>




<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<script>
      
      if (localStorage.getItem('dark-mode') === 'true') {
        document.documentElement.classList.add('dark-mode');
      }
    </script>

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/geist-sans/index.min.css">
<link rel="stylesheet" href="/css/pygments.css">


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="generator" content="Hugo 0.139.3">
  
  <link rel="stylesheet" href="http://localhost:1313/css/bootstrap.min.css">
  
  
  <title>Kalman Filter RLC</title>
  <style>

 
body {
  background-color: #121212;  
  color: #e0e0e0;
  font-family: 'Geist Sans', sans-serif;
  font-weight: 400;
  font-size: 16px;
}

h1, h2, h3 {
  font-family: 'Geist Sans', sans-serif;
  font-weight: 900;
}

.container {
  max-width: 910px;
}

 
#nav-border { border-bottom: 1px solid #333; }
#nav {
  font-family: "Geist Sans", sans-serif;
  position: sticky;
  top: 0;
  background: #121212;
  border-bottom: none;
}
#nav a { font-weight: bold; color: #eee; }
#nav .nav-link { font-weight: 900; }
#nav i { color: inherit; width: 1em; height: 1em; vertical-align: middle; }
#dark-mode-toggle { background: transparent; border: none; cursor: pointer; color: #eee; }
#dark-mode-toggle i { color: inherit; width: 1em; height: 1em; vertical-align: middle; }

body.dark-mode #nav a:hover {
  color: #d0aaff;
}



 
#main { margin-top: 1em; margin-bottom: 4em; }
#home-jumbotron { background-color: inherit; font-family: "Geist Sans", sans-serif; }
#home-jumbotron h1 { font-weight: 900; }
#home-jumbotron p { font-weight: 400; }
.font-125 { font-size: 125%; }
img { max-width: 100%; }
.btn { margin-bottom: 0.3em; margin-right: 0.3em; }

 
a { color: #eee; font-size: 1rem; font-weight: bold; text-decoration: none; }
a:hover { color: #d0aaff; text-decoration: underline; }


.download-link {
  color: #4cc3ff;  
  font-weight: 600;
}

.download-link:hover {
  color: #80d9ff;
  text-decoration: underline;
}

body.light-mode .download-link {
  color: #0066cc;            
}

body.light-mode .download-link:hover {
  color: #004c99;            
}


 
table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
  background: #1e1e1e;
}
th { background-color: #333; color: #fff; padding: 12px; text-align: left; font-weight: bold; text-transform: uppercase; }
td { padding: 12px; border-bottom: 1px solid #444; }
tr:nth-child(even) { background-color: #222; }
tr:hover { background-color: #333; }
@media (max-width: 768px) { table { display: block; overflow-x: auto; white-space: nowrap; } }


body.light-mode th {
  background-color: #f5f5f5;
  color: #000;
  border-bottom: 1px solid #ddd;
}

body.light-mode tr:nth-child(even) {
  background-color: #fcfcfc;
}
body.light-mode tr:hover {
  background-color: #f1f3f5;
}

body.light-mode table {
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #e0e0e0;
}
body.light-mode td {
  border-bottom: 1px solid #eee;
}




 
 

 
div.highlight pre[style],
div.chroma pre[style],
pre[style],
pre.chroma,
pre {
  background-color: #202124 !important;       
  background-image: none !important;
  color: #e2e8f0 !important;
  padding: 1rem !important;
  border-radius: 10px !important;
  border: 1px solid rgba(255,255,255,0.05) !important;
  box-shadow: 0 6px 18px rgba(0,0,0,0.45) !important;
  margin: 1rem 0 !important;
  overflow-x: auto !important;
}

 
div.highlight pre[style] code,
pre[style] code {
  background: none !important;
  color: inherit !important;
  padding: 0 !important;
  margin: 0 !important;
  white-space: pre !important;
}

 
div.highlight, div.chroma {
  background: none !important;
  padding: 0 !important;
  margin: 0 !important;
  box-shadow: none !important;
}


 

.chroma .k  { color: #f92672; }   
.chroma .kc { color: #f92672; }
.chroma .kd { color: #f92672; }
.chroma .kn { color: #f92672; }

.chroma .s  { color: #e6db74; }   
.chroma .sb { color: #e6db74; }
.chroma .sc { color: #e6db74; }

.chroma .n  { color: #f8f8f2; }   
.chroma .na { color: #a6e22e; }
.chroma .nb { color: #66d9ef; }
.chroma .bp { color: #66d9ef; }

.chroma .c  { color: #75715e; font-style: italic; }  
.chroma .cm { color: #75715e; }
.chroma .c1 { color: #75715e; }

 
.chroma .m { color: #ae81ff; }

 
.chroma .o { color: #f92672; }

 
.chroma .nf { color: #a6e22e; }







 
.card {
  border-radius: 12px;
  overflow: hidden;
  background: #1e1e1e;
  box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
  transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s;
}
.card:hover { transform: translateY(-0px); box-shadow: 0px 10px 20px rgba(0,0,0,0.7); }
.card-img-top { width: 100%; height: 200px; object-fit: cover; position: relative; transition: transform 0.3s ease-in-out; }
.card:hover .card-img-top { transform: scale(1.02); }
.card-img-top::before {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.3));
  opacity: 0.5;
  transition: opacity 0.3s ease-in-out;
}
.card:hover .card-img-top::before { opacity: 0.8; }
.card-body { padding: 15px; text-align: center; }
.card-title { font-size: 1.2rem; font-weight: bold; color: #fff; transition: color 0.3s; }
.card:hover .card-title { color: #d0aaff; }

 
.section-travel h1 { text-align: left; margin-bottom: 0.5rem; font-size: 2rem; }
.section-travel .page-subtitle { text-align: center; color: #bbb; font-size: 1.05rem; margin-bottom: 1.5rem; }
.section-travel .travel-cards { display: flex; flex-direction: column; gap: 2rem; }
.section-travel .card { display: flex; flex-direction: column; overflow: hidden; border-radius: 12px; background: #1e1e1e; box-shadow: 0 6px 18px rgba(0,0,0,0.15); }
.section-travel .card:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.25); }
.section-travel .card > a { display: block; color: inherit; text-decoration: none; }
.section-travel .card-img-top { width: 100%; height: 400px; object-fit: cover; object-position: center; border-radius: 12px 12px 0 0; transition: transform 0.35s ease; }
.section-travel .card:hover .card-img-top { transform: scale(1.03); }
.section-travel .card-img-top::before {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.05), rgba(0,0,0,0.15));
  pointer-events: none;
}
.section-travel .card-body { padding: 1.2rem 1rem; text-align: left; }
.section-travel .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.25rem; }
.section-travel time { color: #aaa; font-size: 0.95rem; }
.section-travel .card.no-image { min-height: 160px; background: #222; border: 1px dashed rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; padding: 1.2rem; }
@media (max-width: 600px) { .section-travel .card-img-top { height: 280px; } }

 

 
.section-food.vertical .food-categories {
  display: grid;
  grid-template-columns: repeat(2, 1fr);  
  gap: 1.5rem;
}

@media (max-width: 600px) {
  .section-food.vertical .food-categories {
    grid-template-columns: 1fr;
  }
}


.section-food.vertical .food-categories .card {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-radius: 12px;
  background: #1e1e1e;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  max-width: 600px;  
  width: 100%;
  margin: 0 auto;
}
.section-food.vertical .food-categories .card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.25);
}

 
.section-food.masonry .food-recipes {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  grid-auto-rows: 1fr;
  gap: 1.5rem;
}
.section-food.masonry .food-recipes .card {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-radius: 12px;
  background: #1e1e1e;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.section-food.masonry .food-recipes .card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.25);
}
.section-food .card-img-top { width: 100%; height: 200px; object-fit: cover; object-position: center; border-radius: 12px 12px 0 0; transition: transform 0.3s ease; }
.section-food .card:hover .card-img-top { transform: scale(1.03); }
.section-food .card-body { padding: 1rem; text-align: left; }
.section-food .card-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.25rem; }
@media (max-width: 600px) { 
  .section-food.masonry .food-recipes { grid-template-columns: 1fr; }
  .section-food.vertical .food-categories .card { width: 100%; }
}

body.light-mode .section-food.vertical .food-categories .card {
  background-color: #fff;
  box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
}

body.light-mode .section-food.masonry .food-recipes .card {
  background-color: #fff;
  box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
}




 
button.copybtn { transition: opacity .3s ease-in-out; opacity: .15; padding: 2px 6px; position: absolute; right: 4px; top: 4px; }
div.highlight .copybtn:hover { opacity: 1; border-color: #51a7e8; }
div.highlight { position: relative; }

 
.col { padding-left: 0; }
.small { max-width: 400px; margin: 1rem 0; border-top: 1px solid rgba(255,255,255,0.1); }

 
body.light-mode {
  background-color: #fff;
  color: #000;
}
body.light-mode #nav-border { border-bottom: 1px solid #212529; }
body.light-mode #nav { background-color: #fff; border-bottom: none; }
body.light-mode #nav a { color: #000; }
body.light-mode #nav a:hover { color: #0070f3; }
body.light-mode #dark-mode-toggle { color: #000; }
body.light-mode .card { background-color: #fff; box-shadow: 0px 4px 10px rgba(0,0,0,0.1); }
body.light-mode .card-title { color: #333; }
body.light-mode .card-body { color: #000; }
body.light-mode table { background-color: #fff; color: #000; }
body.light-mode th { background-color: #212529; color: #fff; }
body.light-mode td { border-bottom: 1px solid #ddd; }
body.light-mode a { color: #333; }
body.light-mode a:hover { color: #0070f3; }

 
#dark-mode-toggle i, #nav a, .card, .table, body {
  transition: background-color 0.3s, color 0.3s, box-shadow 0.3s, border-color 0.3s;
}

 
.image-caption { font-size: 0.9em; margin-top: 0.25em; color: #555; }
body.dark-mode .image-caption { color: #ccc; }


body.dark-mode img {
 
  border-radius: 8px;                            
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5);   
  transition: box-shadow 0.3s ease, border-color 0.3s ease;
}

body.light-mode img {
  border-radius: 8px;                             
  transition: box-shadow 0.3s ease, border-color 0.3s ease;
}


 
.custom-image-switch .dark-mode {
  display: none;
}

 
body.dark-mode .custom-image-switch .light-mode {
  display: none;
}
body.dark-mode .custom-image-switch .dark-mode {
  display: inline;
}

 
body.light-mode .custom-image-switch .light-mode {
  display: inline;
}
body.light-mode .custom-image-switch .dark-mode {
  display: none;
}


 
.no-style-image {
  border: none !important;
  box-shadow: none !important;
  border-radius: 0 !important;
  transition: none !important;
}

 

 
.day-nav {
  margin-top: 3rem;
  margin-bottom: 2rem;  
  padding-top: 2.5rem;
  border-top: 1px solid rgba(255,255,255,0.12);
  display: flex;
  justify-content: center;
  gap: 2rem;
}

 
.day-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.6rem;

  padding: 0.8rem 1.6rem;
  border-radius: 30px;
  text-decoration: none;
  font-weight: 600;
  font-size: 1rem;

  background: #1e1e1e;                    
  color: #e0e0e0;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  transition: all 0.2s ease;
}

.day-btn svg {
  width: 20px;
  height: 20px;
  stroke-width: 2.2;
  stroke: currentColor;
}

.day-btn:hover {
  background: #2a2a2a;
  transform: translateY(-3px);
  box-shadow: 0 8px 18px rgba(0,0,0,0.6);
  color: #d0aaff;                         
}

 
body.light-mode .day-nav {
  border-top: 1px solid rgba(0,0,0,0.15);
}

body.light-mode .day-btn {
  background: #f2f2f2;
  color: #000;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

body.light-mode .day-btn:hover {
  background: #e6e6e6;
  color: #0070f3;                          
  box-shadow: 0 8px 18px rgba(0,0,0,0.15);
  transform: translateY(-3px);
}






 
.sharp-responsive-img {
     
    max-width: var(--sharp-max-width) !important;  
    width: 100% !important; 
    height: auto !important;
    
     
    box-sizing: border-box !important;

     
    image-rendering: high-quality !important;
    transform: none !important;  
    display: block !important; 
}





</style>

  <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });

  MathJax.Hub.Config({
  
  TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
</script>







  
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-8PKWFQVGKH"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-8PKWFQVGKH');
        }
      </script>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
</head>  


  <body>
    
        <div id="nav-border" class="container">
  <nav id="nav" class="nav justify-content-center align-items-center">

    
     
      
      
      <a class="nav-link" href="/"><i data-feather="home"></i> Home</a>
     
      
      
      <a class="nav-link" href="/electronics/"><i data-feather="cpu"></i> Electronics</a>
     
      
      
      <a class="nav-link" href="/food/"><i data-feather="heart"></i> Food</a>
     
      
      
      <a class="nav-link" href="/travel/"><i data-feather="aperture"></i> Travel</a>
     
      
      
      <a class="nav-link" href="/misc/"><i data-feather="coffee"></i> Misc</a>
     
      
      
      <a class="nav-link" href="/greenhouse/"><i data-feather="sun"></i> Greenhouse</a>
     
      
      
      <a class="nav-link" href="/archive/"><i data-feather="archive"></i> Archive</a>
    

    
<button id="dark-mode-toggle" class="btn btn-sm ms-2">
  <i></i>
</button>

  </nav>
</div>
 
        
    <div class="container">
      <main id="main">
      
<h1>Kalman Filter RLC</h1>


<i data-feather="calendar"></i> <time datetime="2020-06-01">Jun 1, 2020</time>

<br><br>
<!-- The Kalman filter combines measurements and a theoretical model to best estimate the state of a system. The example below is a simple RLC circuit, which is a second order system. If we imagine an ADC is measuring the  potential difference over the circuit, which will be noisy and for the Kalman filter to work this must be gaussian 
 -->
<style>
  code.has-jax {
    -webkit-font-smoothing: antialiased;
    background: inherit !important;
    border: none !important;
    font-size: 100%;
}  

</style>
<p align="center"> 
<img src="/misc/images/RLC_circuit.svg" alt="RLC" width = 500px>
</p>
<p>The RLC circuit above can be expressed by the following equation</p>
<div>
$$ \ddot{I}_{L} = -\frac{\dot{I}_{L}}{RC}  -\frac{I_L}{LC} + \frac{I}{LC} $$
<p>The equation can be expressed as two first order differential equations using the following method.</p>
<p>$$ x_{1} = I_{L} $$</p>
<p>$$ x_{2} = \dot{I}_{L}$$</p>
</div>
so 
<div>
$$ 
\dot{x}_{2} = \ddot{I}_{L} = -\frac{\dot{I}_{L}}{RC} -\frac{I_{L}}{LC} + \frac{I}{LC}
$$
</div>
<p>and</p>
<div>
$$\dot{x}_{1} =\dot{I}_{L} =  x_{2}$$
</div>
<p>Replacing variables with state variables $\bf{X}$</p>
<div>
$$ \dot{x}_{2} = - \frac{x_{2}}{RC} - \frac{x_{1}}{LC} + \frac{I}{LC} $$
</div>
Using the formula below the derivative can be discretised.  
$$  \dot{x} = \frac{x_{k+1}  - x_k   }{\Delta t} $$
<p>$$ \frac{x_{1_{k+1}} - x_{1_{k}}}   {\Delta t} = x_{2_{k}}$$</p>
<p>rearranging gives the future value for $x_{1}$</p>
<p>$$ x_{1_{k+1}}  = \Delta t x_{2_{k}} + x_{1_{k}} $$</p>
<p>The same method is then applied to $x_{2}$</p>
<p>$$
\frac{x_{2_{k+1}}- x_{2_k}}{\Delta t}  = -\frac{x_{1_k}} {LC}  -\frac{x_{2_{k}}}{RC} + \frac{I_k}{LC}
$$</p>
<p>Giving the future value for $x_{2}$</p>
<p>$$
x_{2_{k+1}} = -\frac{\Delta t x_{1_k}} {LC} -  x_{2_{k}}\left (1- \frac{\Delta t}{RC} \right) + \frac{\Delta t I_k}{LC}
$$</p>
<!-- 
The two equations can then be displayed in state space formalism. I have shifted the time step of the system by -1. The predicted value $x_{1_{k+1}} $ is now predicting the current state of the system as $x_{1_{k}}$ From here on, a hat above a variable indicates a predicted state and a tilde is a measured variable. -->
<p>The two equations can now be expressed in state space formalism. I have shifted the time step by -1 so $x_{1_{k+1}} $ is now $x_{1_{k}}$. This is done to maintain accordance with the kalman filter framework as shown below by the state transition model.</p>
<div>
$$
\hat{X}_k = F_k X_{k-1} + B_{k} U_{k}
$$
</div>
<p>where</p>
<ul>
<li>$\hat{\bf{X}}$ - estimated state</li>
<li>$\bf{X_{k-1}}$ - previous time steps estimated true state (combination of estimate and measurement)</li>
<li>$\bf{F}$ - state transition model</li>
<li>$\bf{B}$ - control input model</li>
<li>$\bf{U}$ - control input</li>
</ul>
<p>From here on, a hat above a variable indicates a predicted state and a tilde is a measured variable.</p>
<div>
\begin{align}
\newcommand{\xoverbrace}[2][\vphantom{\dfrac{A}{A}}]{\overbrace{#1#2}}
\newcommand{\pder}[2]{\frac{\partial#1}{\partial#2}}
\overbrace{
\begin{bmatrix}
\hat{x}_{1_{k}}\\ 
\hat{x}_{2_{k}}
\end{bmatrix}
}^\mathbf{\hat{X}_k}
=
\overbrace{
\begin{bmatrix}
1 & \Delta t \\ 
 -\frac{\Delta t}{LC} &  1 - \frac{\Delta t}{RC}
\end{bmatrix} 
}^\mathbf{F_k}
\:
\overbrace{
\begin{bmatrix}
x_{1_{k-1}}\\  
x_{2_{k-1}}
\end{bmatrix}
}^\mathbf{\hat{{X}}_{k-1}}
+ 
\overbrace{
\begin{bmatrix}
0\\ 
\frac{\Delta t}{LC}
\end{bmatrix}
}^{\mathbf{B_{k}}}
\:
\xoverbrace{
I_{k-1}
}^\mathbf{U_{k}}
\end{align}
</div>
<p>The voltage induced across an inductor is equal to the rate of change of current passing through it multiplied by its inductance.</p>
<div>
$$
\tilde{v}(t) = L\dot{I}_{L}
$$
</div>
<!-- The correction matrix is then equal to the prediction minus the measurement multiplied by the Kalman gain of the system.  -->
<p>The correction matrix takes the predicted value and adjusts it based on a measurement. How much the measurement is incorporated into the prediction is dependent on the Kalman gain.</p>
<div>
$$
\begin{bmatrix}
x_{1_{k}}\\ 
x_{2_{k}}
\end{bmatrix}
= 
\overbrace{
\begin{bmatrix}
\hat{x}_{1_{k}}\\ 
\hat{x}_{2_{k}}
\end{bmatrix}
}^\mathbf{\hat{X}} +
K \left(
\tilde{v}_k -
\overbrace{
\begin{bmatrix}
0 & L
\end{bmatrix} 
}^\textbf{H}
\begin{bmatrix}
\hat{x}_{1_{k}}\\ 
\hat{x}_{2_{k}}
\end{bmatrix}
\right )
$$
</div>
<p>This is all that is needed in terms of design. The rest of the algorithm follows the formula below taken from Wikipedia.</p>
<p align="center"> 
<img src="/misc/images/Kalman_Design_wiki.png" alt="RLC" width = 550px>
</p>
<h3 id="results">Results</h3>
<p align="center"> 
<img src="/misc/images/Inductor_current.png" alt="RLC" width = 800px>
</p>
<p align="center"> 
<img src="/misc/images/Inductor_current_deriv.png" alt="RLC" width = 800px>
</p>
<p align="center"> 
<img src="/misc/images/Inductor_voltage.png" alt="RLC" width = 800px>
</p>
<h2 id="python-implementation">Python Implementation</h2>
<p>The implementation is made in a jupyter notebook which can be downloaded here.
For ease of viewing I have pasted the code segments here -</p>
<!-- <a href="/docs/kalman_RLC.ipynb" download class="download-link">Kalman RLC Notebook
  <i data-feather="download" style="margin-left:6px;"></i>
</a>
 -->
<a href="/docs/kalman_RLC.ipynb" download="Kalman_RLC.ipynb" class="download-link">
  Kalman RLC Notebook
  <i data-feather="download" style="margin-left:6px;"></i>
</a>
<h4 id="requirements">Requirements</h4>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#56b6c2">%</span><span style="color:#e06c75">matplotlib</span> <span style="color:#e06c75">qt</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">numpy</span> <span style="color:#c678dd">as</span> <span style="color:#e06c75">np</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">matplotlib.pyplot</span> <span style="color:#c678dd">as</span> <span style="color:#e06c75">plt</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">from</span> <span style="color:#e06c75">numpy.linalg</span> <span style="color:#c678dd">import</span> <span style="color:#e06c75">inv</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">import</span> <span style="color:#e06c75">copy</span>
</span></span></code></pre></div><h4 id="transition-model">Transition Model</h4>
<div>
$$
\hat{X}_k = F_k X_{k-1} + B_{k} U_{k}
$$
</div>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#c678dd">def</span> <span style="color:#61afef;font-weight:bold">prediction</span>(<span style="color:#e06c75">Il</span>,<span style="color:#e06c75">Ildot</span>,<span style="color:#e06c75">I</span>,<span style="color:#e06c75">t</span>):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">L</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">C</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">500e-9</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">R</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">50e3</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">A</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">array</span>([[<span style="color:#d19a66">1</span>, <span style="color:#e06c75">t</span>],
</span></span><span style="display:flex;"><span>                  [<span style="color:#56b6c2">-</span><span style="color:#e06c75">t</span><span style="color:#56b6c2">/</span>(<span style="color:#e06c75">L</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">C</span>), <span style="color:#d19a66">1</span> <span style="color:#56b6c2">-</span> (<span style="color:#e06c75">t</span><span style="color:#56b6c2">/</span>(<span style="color:#e06c75">R</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">C</span>))]])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">X</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">array</span>([[<span style="color:#e06c75">Il</span>],
</span></span><span style="display:flex;"><span>                 [<span style="color:#e06c75">Ildot</span>]])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">B</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">array</span>([[<span style="color:#d19a66">0</span>],
</span></span><span style="display:flex;"><span>                  [<span style="color:#e06c75">t</span><span style="color:#56b6c2">/</span>(<span style="color:#e06c75">L</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">C</span>)]])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">U</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">I</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">X_prediction</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">A</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">X</span>) <span style="color:#56b6c2">+</span> <span style="color:#e06c75">B</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">U</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#c678dd">return</span> <span style="color:#e06c75">X_prediction</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#7f848e">#time </span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">T</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0.14</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">t</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">linspace</span>(<span style="color:#d19a66">0</span>,<span style="color:#e06c75">T</span>,<span style="color:#d19a66">100e3</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">T</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#initialise inductor current and its derivertive</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Il_true</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">zeros</span>(<span style="color:#e5c07b">len</span>(<span style="color:#e06c75">t</span>))
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Ildot_true</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">zeros</span>(<span style="color:#e5c07b">len</span>(<span style="color:#e06c75">t</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#cicuit component definitions</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">L</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">5</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">C</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">500e-9</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">R</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">50e3</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#create input signal </span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">wr</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">1</span><span style="color:#56b6c2">/</span><span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">sqrt</span>(<span style="color:#e06c75">L</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">C</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">I_true</span> <span style="color:#56b6c2">=</span> <span style="color:#d19a66">25e-6</span> <span style="color:#56b6c2">*</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">sin</span>(<span style="color:#e06c75">wr</span> <span style="color:#56b6c2">*</span> <span style="color:#e06c75">t</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#time step</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">dt</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">t</span>[<span style="color:#d19a66">1</span>] <span style="color:#56b6c2">-</span> <span style="color:#e06c75">t</span>[<span style="color:#d19a66">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#create True data </span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">I</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">zeros</span>((<span style="color:#d19a66">2</span>,<span style="color:#e5c07b">len</span>(<span style="color:#e06c75">t</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">in</span> <span style="color:#e5c07b">range</span>(<span style="color:#d19a66">1</span>,<span style="color:#e5c07b">len</span>(<span style="color:#e06c75">t</span>)):
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">a</span> <span style="color:#56b6c2">=</span>  <span style="color:#e06c75">prediction</span>(<span style="color:#e06c75">I</span>[<span style="color:#d19a66">0</span>][<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>],<span style="color:#e06c75">I</span>[<span style="color:#d19a66">1</span>][<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>],<span style="color:#e06c75">I_true</span>[<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>],<span style="color:#e06c75">dt</span>)<span style="color:#56b6c2">.</span><span style="color:#e06c75">T</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">I</span>[:,<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">a</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Il_true</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">I</span>[<span style="color:#d19a66">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Ildot_true</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">I</span>[<span style="color:#d19a66">1</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#e06c75">V_true</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">L</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">Ildot_true</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">noise</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">random</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">normal</span>(<span style="color:#e06c75">loc</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0</span>, <span style="color:#e06c75">scale</span><span style="color:#56b6c2">=</span><span style="color:#d19a66">0.5</span>, <span style="color:#e06c75">size</span><span style="color:#56b6c2">=</span><span style="color:#e5c07b">len</span>(<span style="color:#e06c75">t</span>))
</span></span><span style="display:flex;"><span><span style="color:#e06c75">V_meas</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">V_true</span> <span style="color:#56b6c2">+</span> <span style="color:#e06c75">noise</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#7f848e">#state transition model </span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">A</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">array</span>([[<span style="color:#d19a66">1</span>, <span style="color:#e06c75">dt</span>],
</span></span><span style="display:flex;"><span>              [<span style="color:#56b6c2">-</span><span style="color:#e06c75">dt</span><span style="color:#56b6c2">/</span>(<span style="color:#e06c75">L</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">C</span>), (<span style="color:#d19a66">1</span> <span style="color:#56b6c2">-</span> (<span style="color:#e06c75">dt</span><span style="color:#56b6c2">/</span>(<span style="color:#e06c75">R</span><span style="color:#56b6c2">*</span><span style="color:#e06c75">C</span>)))]],<span style="color:#e06c75">dtype</span><span style="color:#56b6c2">=</span><span style="color:#98c379">&#39;float&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#process noise(model noise)</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Q</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">array</span>([[<span style="color:#d19a66">4e-9</span>, <span style="color:#d19a66">0</span>],
</span></span><span style="display:flex;"><span>              [<span style="color:#d19a66">0</span>, <span style="color:#d19a66">4e-9</span>]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#measurement noise</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">R</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">array</span>([[<span style="color:#d19a66">4</span>]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#Initial Predicted (a priori) estimate</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">P</span><span style="color:#56b6c2">=</span><span style="color:#e06c75">Q</span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#store values for plotting</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Il_a</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">zeros</span>([<span style="color:#e5c07b">len</span>(<span style="color:#e06c75">t</span>)])
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Ildot_a</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">zeros</span>([<span style="color:#e5c07b">len</span>(<span style="color:#e06c75">t</span>)])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#initial values</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Il_a</span>[<span style="color:#d19a66">0</span>]    <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">Ildot_a</span>[<span style="color:#d19a66">0</span>] <span style="color:#56b6c2">=</span> <span style="color:#d19a66">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">#set the input matrix to be the true input</span>
</span></span><span style="display:flex;"><span><span style="color:#e06c75">I_a</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">I_true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e"># for i in range(1,len(t)):</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">for</span> <span style="color:#e06c75">i</span> <span style="color:#56b6c2">in</span> <span style="color:#e5c07b">range</span>(<span style="color:#e5c07b">len</span>(<span style="color:#e06c75">t</span>)):
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">#prediction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">X_hat</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">prediction</span>(<span style="color:#e06c75">Il_a</span>[<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>], <span style="color:#e06c75">Ildot_a</span>[<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>], <span style="color:#e06c75">I_a</span>[<span style="color:#e06c75">i</span><span style="color:#56b6c2">-</span><span style="color:#d19a66">1</span>],<span style="color:#e06c75">dt</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">#predicted estimate covariance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">P_hat</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">diag</span>(<span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">diag</span>(<span style="color:#e06c75">A</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">P</span>)<span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">A</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">T</span>))) <span style="color:#56b6c2">+</span> <span style="color:#e06c75">Q</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">#observation matrix v(t) = Ldi/dt</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">H</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">array</span>([[<span style="color:#d19a66">0</span>,<span style="color:#e06c75">L</span>]])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">#innovation covariance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">S</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">H</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">P_hat</span>)<span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">H</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">T</span>) <span style="color:#56b6c2">+</span> <span style="color:#e06c75">R</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e"># Kalman Gain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">K</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">P_hat</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">H</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">T</span>)<span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">inv</span>(<span style="color:#e06c75">S</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">#measurement - prediction </span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">y</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">V_meas</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">-</span> <span style="color:#e06c75">H</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">X_hat</span>)   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">#updated state estimate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">X</span> <span style="color:#56b6c2">=</span> <span style="color:#e06c75">X_hat</span> <span style="color:#56b6c2">+</span> <span style="color:#e06c75">K</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">y</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">#Updated (a posteriori) estimate covariance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">P</span> <span style="color:#56b6c2">=</span> (<span style="color:#e06c75">np</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">identity</span>(<span style="color:#d19a66">2</span>) <span style="color:#56b6c2">-</span> <span style="color:#e06c75">K</span><span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">H</span>))<span style="color:#56b6c2">.</span><span style="color:#e06c75">dot</span>(<span style="color:#e06c75">P_hat</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">#update values</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Il_a</span>[<span style="color:#e06c75">i</span>]    <span style="color:#56b6c2">=</span> <span style="color:#e06c75">X</span>[<span style="color:#d19a66">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">Ildot_a</span>[<span style="color:#e06c75">i</span>] <span style="color:#56b6c2">=</span> <span style="color:#e06c75">X</span>[<span style="color:#d19a66">1</span>]
</span></span></code></pre></div>



<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'www-mybrainhertz-co-uk';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </main>

    </div>
    
<script src="http://localhost:1313/js/feather.min.js"></script>

<script>
const toggle = document.getElementById('dark-mode-toggle');
const body = document.body;


body.classList.add('dark-mode');


const saved = localStorage.getItem('dark-mode');
if (saved === 'true') {
  body.classList.add('dark-mode');
  body.classList.remove('light-mode');
} else if (saved === 'false') {
  body.classList.remove('dark-mode');
  body.classList.add('light-mode');
}


function updateIcon() {
  const iconEl = toggle.querySelector('i');
  if (body.classList.contains('dark-mode')) {
    iconEl.setAttribute('data-feather', 'moon'); 
  } else {
    iconEl.setAttribute('data-feather', 'sun');  
  }
  feather.replace(); 
}


updateIcon();


toggle.addEventListener('click', () => {
  if (body.classList.contains('dark-mode')) {
    body.classList.remove('dark-mode');
    body.classList.add('light-mode');
    localStorage.setItem('dark-mode', 'false');
  } else {
    body.classList.add('dark-mode');
    body.classList.remove('light-mode');
    localStorage.setItem('dark-mode', 'true');
  }
  updateIcon();
});
</script>
   
    <script>
function addCopyButtonToCode() {
  var allCodeBlocksElements = $("div.highlight pre");

  allCodeBlocksElements.each(function(ii) {
    var currentId = "codeblock" + (ii + 1);
    $(this).attr("id", currentId);

    
    var iconColor = document.body.classList.contains("dark-mode") ? "#e2e8f0" : "#333";

    
    var clipButton = `
      <button class="btn copybtn" data-clipboard-target="#${currentId}">
        <i data-feather="copy" width="20" style="color: ${iconColor}"></i>
      </button>
    `;

    $(this).after(clipButton);
  });

  feather.replace(); 

  
  var clipboard = new Clipboard(".btn");
  clipboard.on("success", function(e) {
    setTimeout(function() {
      e.clearSelection();
    }, 250);
  });
  clipboard.on("error", function(e) {
    $(e.trigger).text("Can't in Safari");
  });
}


$(document).ready(function() {
  addCopyButtonToCode();
});



</script>   
  </body>
</html>